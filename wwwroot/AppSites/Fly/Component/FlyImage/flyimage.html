<script>
    function hideMachineImageViewer() {

        let modal = document.querySelector('#machineImageViewer');
        modal.classList.remove('is-active');
    }

    function showMachineImageViewer(progressElmId) {
        let modal = document.querySelector('#machineImageViewer');
        modal.classList.add('is-active');
    }

    function flyBackupImage(progressElmId, responseElmId, authTokenVal, appNameVal, imageTagVal, successCallback) {

        var id = window.ajaxid++;
        var responseElm = getElm(responseElmId);
        var responseContainerElmId = responseElmId + "Container";
        responseElm.textContent = '';
        hideElm(responseContainerElmId);
        var valid = true;

        if (valid == true) {
            if (appNameVal.trim().length === 0) {
                showText(responseElm, 'Enter App Name', 'red');
                valid = false;
            }
        }

        if (valid === true) {

            let url = '/AppApi/FlyApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'BackupImage', "params": {
                    "fly_api_token": authTokenVal,
                    "app_name": appNameVal,
                    "image_tag": imageTagVal
                }, "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;

                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');

                            if (result.hasOwnProperty('messageJson') === true) {
                                let messageJsonText = "";
                                let messageJson = result.messageJson;
                                for (let key in messageJson) {
                                    let value = messageJson[key];
                                    messageJsonText = messageJsonText + value + "<br/>";
                                }

                                var responseJsonElmId = responseElmId + "Json";
                                getElm(responseJsonElmId).innerHTML = messageJsonText;
                            }

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                },
                function (data) {
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var result = data.Error;
                        if (result.hasOwnProperty('Message') === true) {
                            showText(responseElm, result.Message, 'red');
                        }
                    }
                    else if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                });
        }
    }

    function flyUpdateMachineRefreshImage(progressElmId, responseElmId, authTokenVal, appNameVal, dockerImageVal, successCallback) {

        var id = window.ajaxid++;
        var responseElm = getElm(responseElmId);
        var responseContainerElmId = responseElmId + "Container";
        responseElm.textContent = '';
        hideElm(responseContainerElmId);
        var valid = true;

        if (valid == true) {
            if (appNameVal.trim().length === 0) {
                showText(responseElm, 'Enter App Name', 'red');
                valid = false;
            }
        }

        if (valid === true) {

            let url = '/AppApi/FlyApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'UpdateMachineRefreshImage', "params": {
                    "fly_api_token": authTokenVal,
                    "org_slug": "",
                    "app_name": appNameVal,
                    "docker_image": dockerImageVal
                }, "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;

                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');

                            if (result.hasOwnProperty('messageJson') === true) {
                                let messageJsonText = "";
                                let messageJson = result.messageJson;
                                for (let key in messageJson) {
                                    let value = messageJson[key];
                                    messageJsonText = messageJsonText + value + "<br/>";
                                }

                                var responseJsonElmId = responseElmId + "Json";
                                getElm(responseJsonElmId).innerHTML = messageJsonText;
                            }

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                },
                function (data) {
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var result = data.Error;
                        if (result.hasOwnProperty('Message') === true) {
                            showText(responseElm, result.Message, 'red');
                        }
                    }
                    else if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                });
        }
    }

    function flyReplaceMachineRefreshImage(progressElmId, responseElmId, authTokenVal, appNameVal, dockerImageVal, successCallback) {

        var id = window.ajaxid++;
        var responseElm = getElm(responseElmId);
        var responseContainerElmId = responseElmId + "Container";
        responseElm.textContent = '';
        hideElm(responseContainerElmId);
        var valid = true;

        if (valid == true) {
            if (appNameVal.trim().length === 0) {
                showText(responseElm, 'Enter App Name', 'red');
                valid = false;
            }
        }

        if (valid === true) {

            let url = '/AppApi/FlyApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'ReplaceMachineRefreshImage', "params": {
                    "fly_api_token": authTokenVal,
                    "org_slug": "",
                    "app_name": appNameVal,
                    "docker_image": dockerImageVal
                }, "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;

                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');

                            if (result.hasOwnProperty('messageJson') === true) {
                                let messageJsonText = "";
                                let messageJson = result.messageJson;
                                for (let key in messageJson) {
                                    let value = messageJson[key];
                                    messageJsonText = messageJsonText + value + "<br/>";
                                }

                                var responseJsonElmId = responseElmId + "Json";
                                getElm(responseJsonElmId).innerHTML = messageJsonText;
                            }

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                },
                function (data) {
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var result = data.Error;
                        if (result.hasOwnProperty('Message') === true) {
                            showText(responseElm, result.Message, 'red');
                        }
                    }
                    else if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                });
        }
    }

</script>

<div style="text-align:center">
    <div id="machineImageProgress" style="margin:0 auto;width:10px;"></div>
</div>

<div class="notification" id="machineImageResponseContainer" style="margin:5px; padding:10px;text-align:justify;display:none;">
    <button class="delete" onclick="hideElm('machineImageResponseContainer')"></button>
    <div id="machineImageResponse"></div>
</div>

<div class="modal" id="machineImageViewer">
    <div class="modal-background"></div>
    <div class="modal-content" style="background-color:#fff;max-width:90%;">

        <div class="flex-content-wrap">
            <button class="flex-item-stretch">Manage Machine Image</button>
            <button class="border" style="margin-top:7px;width:25px;height:25px;background-color: lightgray;" onclick="hideMachineImageViewer()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <div style="margin: 10px;">
            
            <div class="notification is-marginless" id="imageActionResponseContainer" style="display:none;" onclick="toggleElm('imageActionResponseJson');toggleElm('imageActionResponseOpen'); toggleElm('imageActionResponseClose');">
                <button class="delete" onclick="hideElm('imageActionResponseContainer');"></button>
                <svg xmlns="http://www.w3.org/2000/svg" id="imageActionResponseOpen" style="width: 16px; height: 16px; margin: 0 10px 0 0; display: none;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 13l-7 7-7-7m14-8l-7 7-7-7" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" id="imageActionResponseClose" style="width:16px;height:16px;margin:0 10px 0 0;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 11l7-7 7 7M5 19l7-7 7 7" />
                </svg>
                <span id="imageActionResponse"></span>
                <div id="imageActionResponseJson" style="display:none;"></div>
            </div>

            <div class="flex-content-wrap">
                <label style="width:100%;margin: 5px auto;">Machine Image Repository*</label>
                <div class="flex-item-stretch border" style="height: 40px;">
                    <select id="flyBackupAppName" style="width:100%;border:none;padding: 0 0 0 5px" onchange="if (this.value == '{{$FlyAppName}}') { getElm('machineImageTag').value = 'latest' } else { getElm('machineImageTag').value = '{{$FlyAppName}}' }">
                        {{@BackupAppName}}
                        <option {{@IsDefault}} selected="selected" {{/IsDefault}}>{{$AppName}}</option>
                        {{/BackupAppName}}
                        <option>{{$FlyAppName}}</option>
                    </select>
                </div>
            </div>

            <div class="flex-content-wrap">
                <label style="width:100%;margin: 5px auto;">Machine Image*</label>
                <div class="flex-item-stretch border" style="height: 40px;">
                    <select id="restoreDockerImages" style="width:100%;border:none;padding: 0 0 0 5px">
                        {{@RestoreImages}}
                        <option {{@IsDefault}} selected="selected" {{/IsDefault}}>{{$ImageName}}</option>
                        {{/RestoreImages}}
                    </select>
                </div>
            </div>

            <div class="flex-content-wrap" style="margin: 10px 0px;">
                <button class="border" style="width: 125px; height: 60px; background-color: lightgray; margin:0 5px 0 0"
                        onclick="flyRefreshRestoreImage('restoreImageProgress', 'imageActionResponse', '', getElm('flyBackupAppName').value, getElm('restoreDockerImages').value, function () { })">
                    All Machine Restore Image <div id="restoreImageProgress"></div>
                </button>
                <button class="border" style="width: 125px; height: 60px; background-color: lightgray; margin: 0 0 0 5px"
                        onclick="flyRefreshReplaceImage('replaceImageProgress', 'imageActionResponse', '', getElm('flyBackupAppName').value, getElm('restoreDockerImages').value, function () { })">
                    All Machine Replace Image <div id="replaceImageProgress"></div>
                </button>
            </div>

            <div class="flex-content-wrap">
                <label style="width:100%;margin: 5px auto;">Machine Image Tag*</label>
                <div class="flex-item-stretch border" style="height: 40px;">
                    <input style="width:100%;border:none;" id="machineImageTag" type="text" placeholder="Docker Image Tag" value="{{$FlyAppName}}" />
                </div>
            </div>
            <div style="font-size:xx-small">Optional append information like version using ~ after tag name. Eg. {{$FlyAppName}}~{{$DateNo}}</div>

            <div class="flex-content-wrap" style="margin: 10px 0px;">
                <button class="border" style="width: 125px; height: 60px; background-color: lightgray;"
                        onclick="flyBackupImage('backupImageProgress', 'imageActionResponse', '', getElm('flyBackupAppName').value, getElm('machineImageTag').value, function () { })">
                    Current Machine Backup Image <div id="backupImageProgress"></div>
                </button>
            </div>

        </div>
    </div>
</div>