
<script>

    function flyUpdateMachineRefreshImage(progressElmId, responseElmId, authTokenVal, orgSlugVal, appNameVal, successCallback) {

        var id = window.ajaxid++;
        var responseElm = getElm(responseElmId);
        var responseContainerElmId = responseElmId + "Container";
        responseElm.textContent = '';
        hideElm(responseContainerElmId);
        var valid = true;

        if (valid == true) {
            if (orgSlugVal.trim().length === 0) {
                showText(responseElm, 'Select Org Slug', 'red');
                valid = false;
            }
        }

        //if (valid == true) {
        //    if (appNameVal.trim().length === 0) {
        //        showText(responseElm, 'Enter App Name', 'red');
        //        valid = false;
        //    }
        //}

        if (valid === true) {

            let url = '/AppApi/FlyApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'UpdateMachineRefreshImage', "params": {
                    "fly_api_token": authTokenVal,
                    "org_slug": orgSlugVal,
                    "app_name": appNameVal,
                    "docker_image": ""
                }, "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;

                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');
                            
                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }

                        if (result.hasOwnProperty('json') === true) {
                            let messageJsonText = "";
                            let messageJson = result.json;
                            for (let key in messageJson) {
                                let messageValue = messageJson[key];
                                for (let messageKey in messageValue) {
                                    messageJsonText = messageJsonText + messageKey + ":" + messageValue[messageKey] + "<br/>";
                                }
                            }

                            let errorJsonText = "";
                            if (result.hasOwnProperty('errorjson') === true) {
                                let errorJson = result.errorjson;
                                for (let key in errorJson) {
                                    let messageValue = errorJson[key];
                                    for (let messageKey in messageValue) {
                                        errorJsonText = errorJsonText + value + "<br/>";
                                    }
                                }
                            }

                            var responseJsonElmId = responseElmId + "Json";
                            getElm(responseJsonElmId).innerHTML = messageJsonText + errorJsonText;
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                },
                function (data) {
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var result = data.Error;
                        if (result.hasOwnProperty('Message') === true) {
                            showText(responseElm, result.Message, 'red');
                        }
                    }
                    else if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                });
        }
    }

    function flyReplaceMachineRefreshImage(progressElmId, responseElmId, authTokenVal, orgSlugVal, appNameVal, successCallback) {

        var id = window.ajaxid++;
        var responseElm = getElm(responseElmId);
        var responseContainerElmId = responseElmId + "Container";
        responseElm.textContent = '';
        hideElm(responseContainerElmId);
        var valid = true;

        if (valid == true) {
            if (orgSlugVal.trim().length === 0) {
                showText(responseElm, 'Select Org Slug', 'red');
                valid = false;
            }
        }

        //if (valid == true) {
        //    if (appNameVal.trim().length === 0) {
        //        showText(responseElm, 'Enter App Name', 'red');
        //        valid = false;
        //    }
        //}

        if (valid === true) {

            let url = '/AppApi/FlyApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'ReplaceMachineRefreshImage', "params": {
                    "fly_api_token": authTokenVal,
                    "org_slug": orgSlugVal,
                    "app_name": appNameVal,
                    "docker_image": ""
                }, "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        
                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }

                        if (result.hasOwnProperty('json') === true) {
                            let messageJsonText = "";
                            let messageJson = result.json;
                            for (let key in messageJson) {
                                let messageValue = messageJson[key];
                                for (let messageKey in messageValue) {
                                    messageJsonText = messageJsonText + messageKey + ":" + messageValue[messageKey] + "<br/>";
                                }
                            }

                            let errorJsonText = "";
                            if (result.hasOwnProperty('errorjson') === true) {
                                let errorJson = result.errorjson;
                                for (let key in errorJson) {
                                    let messageValue = errorJson[key];
                                    for (let messageKey in messageValue) {
                                        errorJsonText = errorJsonText + value + "<br/>";
                                    }
                                }
                            }

                            var responseJsonElmId = responseElmId + "Json";
                            getElm(responseJsonElmId).innerHTML = messageJsonText + errorJsonText;
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                },
                function (data) {
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var result = data.Error;
                        if (result.hasOwnProperty('Message') === true) {
                            showText(responseElm, result.Message, 'red');
                        }
                    }
                    else if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                });
        }
    }

    function flyBackupImage(progressElmId, responseElmId, authTokenVal, appNameVal, imageTagVal, successCallback) {

        var id = window.ajaxid++;
        var responseElm = getElm(responseElmId);
        var responseContainerElmId = responseElmId + "Container";
        responseElm.textContent = '';
        hideElm(responseContainerElmId);
        var valid = true;
      
        if (valid == true) {
            if (appNameVal.trim().length === 0) {
                showText(responseElm, 'Enter App Name', 'red');
                valid = false;
            }
        }

        if (valid === true) {

            let url = '/AppApi/FlyApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'BackupImage', "params": {
                    "fly_api_token": authTokenVal,
                    "app_name": appNameVal,
                    "image_tag": imageTagVal
                }, "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;

                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');

                            if (result.hasOwnProperty('messageJson') === true) {
                                let messageJsonText = "";
                                let messageJson = result.messageJson;
                                for (let key in messageJson) {
                                    let value = messageJson[key];   
                                    messageJsonText = messageJsonText + value + "<br/>";
                                }

                                var responseJsonElmId = responseElmId + "Json";
                                getElm(responseJsonElmId).innerHTML = messageJsonText;
                            }

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                },
                function (data) {
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var result = data.Error;
                        if (result.hasOwnProperty('Message') === true) {
                            showText(responseElm, result.Message, 'red');
                        }
                    }
                    else if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                });
        }
    }

    function flyPushRemoteImage(progressElmId, responseElmId, authTokenVal, appNameVal, dockerImageVal, successCallback) {

        var id = window.ajaxid++;
        var responseElm = getElm(responseElmId);
        var responseContainerElmId = responseElmId + "Container";
        responseElm.textContent = '';
        hideElm(responseContainerElmId);
        var valid = true;

        if (valid == true) {
            if (appNameVal.trim().length === 0) {
                showText(responseElm, 'Enter App Name', 'red');
                valid = false;
            }
        }

        if (valid == true) {
            if (dockerImageVal.trim().length === 0) {
                showText(responseElm, 'Enter Docker Image Name', 'red');
                valid = false;
            }
        }

        if (valid === true) {

            let url = '/AppApi/FlyApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'PushRemoteImage', "params": {
                    "fly_api_token": authTokenVal,
                    "app_name": appNameVal,
                    "docker_image": dockerImageVal
                }, "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;

                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');

                            if (result.hasOwnProperty('messageJson') === true) {
                                let messageJsonText = "";
                                let messageJson = result.messageJson;
                                for (let key in messageJson) {
                                    let value = messageJson[key];
                                    messageJsonText = messageJsonText + value + "<br/>";
                                }

                                var responseJsonElmId = responseElmId + "Json";
                                getElm(responseJsonElmId).innerHTML = messageJsonText;
                            }

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                },
                function (data) {
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var result = data.Error;
                        if (result.hasOwnProperty('Message') === true) {
                            showText(responseElm, result.Message, 'red');
                        }
                    }
                    else if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                });
        }
    }

</script>

<div class="notification is-marginless" id="flyImageResponseContainer" style="display:none;" onclick="toggleElm('flyImageResponseJson');toggleElm('flyImageResponseOpen'); toggleElm('flyImageResponseClose');">
    <button class="delete" onclick="hideElm('flyImageResponseContainer');"></button>
    <svg xmlns="http://www.w3.org/2000/svg" id="flyImageResponseOpen" style="width: 16px; height: 16px; margin: 0 10px 0 0; display: none;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 13l-7 7-7-7m14-8l-7 7-7-7" />
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" id="flyImageResponseClose" style="width:16px;height:16px;margin:0 10px 0 0;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 11l7-7 7 7M5 19l7-7 7 7" />
    </svg>
    <span id="flyImageResponse"></span>
    <div id="flyImageResponseJson" style="display:none;"></div>
</div>

<div class="flex-card card_border">

    <div class="flex-content-wrap" style="margin: 5px 5px;width:100%;min-height:0px;" onclick="toggleElm('manageFlyImages');toggleElm('flyImageOpen'); toggleElm('flyImageClose');">
        <div class="flex-item-stretch" style="text-align:center;">
            <strong>Refresh/Backup/Push Docker Images</strong>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" id="flyImageOpen" style="width:16px;height:16px;margin:0 10px 0 0;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 13l-7 7-7-7m14-8l-7 7-7-7" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="flyImageClose" style="width:16px;height:16px;margin:0 10px 0 0;display:none;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 11l7-7 7 7M5 19l7-7 7 7" />
        </svg>
    </div>

    <div id="manageFlyImages" style="display:none;">

        <div class="flex-content-wrap">
            <label style="width:100%;margin: 5px auto;">Image App Name</label>
            <div class="flex-item-stretch border" style="height: 40px;">
                <input style="width:100%;border:none;" id="imageAppName" type="text" placeholder="Image App Name" value="{{$FlyAppName}}" />
            </div>
        </div>

        <div class="flex-content-wrap" style="width:100%;text-align: center;margin: 10px 0px;">
            <button class="button border" id="pushImage" style="margin: 0 5px 5px 0; width: 150px; height: 60px;  background-color: lightgray; color: black; font-weight: bolder;"
                    onclick="flyUpdateMachineRefreshImage('flyUpdateMachineRefreshImageProgress', 'flyImageResponse', getElm('flyAuthToken').value, getElm('flyOrgSlug').value, getElm('imageAppName').value, function () { })">
                Update Machine Refresh Image <div id="flyUpdateMachineRefreshImageProgress"></div>
            </button>
            <button class="button border" id="pushImage" style="margin: 0 5px 5px 0; width: 150px; height: 60px;  background-color: lightgray; color: black; font-weight: bolder;"
                    onclick="flyReplaceMachineRefreshImage('flyReplaceMachineRefreshImageProgress', 'flyImageResponse', getElm('flyAuthToken').value, getElm('flyOrgSlug').value, getElm('imageAppName').value, function () { })">
                Replace Machine Refresh Image <div id="flyReplaceMachineRefreshImageProgress"></div>
            </button>
        </div>

        <div class="flex-content-wrap">
            <label style="width:100%;margin: 5px auto;">Image Tag*</label>
            <div class="flex-item-stretch border" style="height: 40px;">
                <input style="width:100%;border:none;" type="text" id="flyImageTag" placeholder="Image Tag" value="latest" />
            </div>
        </div>
        <div style="font-size:xx-small">Append information like version using ~ after tag name. Eg. {{$FlyAppName}}~{{$DateNo}}</div>

        <div class="flex-content-wrap" style="width:100%;text-align: center;margin: 10px 0px;">
            <button class="button border" id="pushImage" style="margin: 0 5px 5px 0; width: 150px; height: 60px; background-color: lightgray; color: black; font-weight: bolder;"
                    onclick="flyBackupImage('flyBackupImageProgress', 'flyImageResponse', getElm('flyAuthToken').value, getElm('imageAppName').value, getElm('flyImageTag').value, function () { })">
                Current Machine Backup Image <div id="flyBackupImageProgress"></div>
            </button>
        </div>

        <div class="flex-content-wrap" style="margin: 5px 0px;">
            <label style="color:blue;font-size:x-small">Backup Image will save the existing machine including any changes as latest docker image which will get reflected on machine update</label>
        </div>

        <div class="flex-content-wrap">
            <label style="width:100%;margin: 5px auto;">Docker Image*</label>
            <div class="flex-item-stretch border" style="height: 40px;">
                <div class="flex-item-stretch border" style="height: 40px;">
                    <input style="width:100%;border:none;" id="dockerImage" type="text" placeholder="Docker Image Full Name" value="" />
                </div>
            </div>
        </div>

        <div class="flex-content-wrap" style="width:100%;text-align: center;margin: 10px 0px;">
            <button class="button border" id="pushImage" style="margin: 0 5px 5px 0; width: 125px; height: 60px; background-color: lightgray; color: black; font-weight: bolder;"
                    onclick="flyPushRemoteImage('flyPushImageProgress', 'flyImageResponse', getElm('flyAuthToken').value, getElm('imageAppName').value, getElm('dockerImage').value, function () { })">
                Docker Push Image <div id="flyPushImageProgress"></div>
            </button>
        </div>

        <div class="flex-content-wrap" style="margin: 5px 0px;">
            <label style="color:red;font-size:x-small">Warning: Pushing new Docker Image will overwrite exiting docker image of the current app which will get reflected on machine update</label>
        </div>

    </div>

</div>


