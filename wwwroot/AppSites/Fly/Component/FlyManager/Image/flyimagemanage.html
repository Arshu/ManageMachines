
<script>

    function flyRefreshMachineImage(progressElmId, responseElmId, authTokenVal, orgSlugVal, appNameVal, successCallback) {

        var id = window.ajaxid++;
        var responseElm = getElm(responseElmId);
        var responseContainerElmId = responseElmId + "Container";
        responseElm.textContent = '';
        hideElm(responseContainerElmId);
        var valid = true;

        if (valid == true) {
            if (orgSlugVal.trim().length === 0) {
                showText(responseElm, 'Select Org Slug', 'red');
                valid = false;
            }
        }

        if (valid == true) {
            if (appNameVal.trim().length === 0) {
                showText(responseElm, 'Enter App Name', 'red');
                valid = false;
            }
        }

        if (valid === true) {

            let url = '/AppApi/FlyApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'RefreshMachineImage', "params": {
                    "fly_api_token": authTokenVal,
                    "org_slug": orgSlugVal,
                    "app_name": appNameVal
                }, "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;

                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                },
                function (data) {
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var result = data.Error;
                        if (result.hasOwnProperty('Message') === true) {
                            showText(responseElm, result.Message, 'red');
                        }
                    }
                    else if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                });
        }
    }

    function flyUpdateImage(progressElmId, responseElmId, authTokenVal, orgSlugVal, appNameVal, successCallback) {

        var id = window.ajaxid++;
        var responseElm = getElm(responseElmId);
        var responseContainerElmId = responseElmId + "Container";
        responseElm.textContent = '';
        hideElm(responseContainerElmId);
        var valid = true;

        if (valid == true) {
            if (orgSlugVal.trim().length === 0) {
                showText(responseElm, 'Select Org Slug', 'red');
                valid = false;
            }
        }

        if (valid == true) {
            if (appNameVal.trim().length === 0) {
                showText(responseElm, 'Enter App Name', 'red');
                valid = false;
            }
        }

        if (valid === true) {

            let url = '/AppApi/FlyApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'UpdateImage', "params": {
                    "fly_api_token": authTokenVal,
                    "org_slug": orgSlugVal,
                    "app_name": appNameVal
                }, "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;

                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                },
                function (data) {
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var result = data.Error;
                        if (result.hasOwnProperty('Message') === true) {
                            showText(responseElm, result.Message, 'red');
                        }
                    }
                    else if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                });
        }
    }

    function flyPushImage(progressElmId, responseElmId, authTokenVal, appNameVal, dockerImageVal, successCallback) {

        var id = window.ajaxid++;
        var responseElm = getElm(responseElmId);
        var responseContainerElmId = responseElmId + "Container";
        responseElm.textContent = '';
        hideElm(responseContainerElmId);
        var valid = true;

        if (valid == true) {
            if (appNameVal.trim().length === 0) {
                showText(responseElm, 'Enter App Name', 'red');
                valid = false;
            }
        }

        if (valid == true) {
            if (dockerImageVal.trim().length === 0) {
                showText(responseElm, 'Enter Docker Image Name', 'red');
                valid = false;
            }
        }

        if (valid === true) {

            let url = '/AppApi/FlyApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'PushImage', "params": {
                    "fly_api_token": authTokenVal,
                    "app_name": appNameVal,
                    "docker_image": dockerImageVal
                }, "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;

                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                },
                function (data) {
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        var result = data.Error;
                        if (result.hasOwnProperty('Message') === true) {
                            showText(responseElm, result.Message, 'red');
                        }
                    }
                    else if (data.hasOwnProperty('Result') === true) {
                        var result = data.Result;
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                });
        }
    }

</script>

<div class="notification is-marginless" id="flyImageResponseContainer" style="display:none;">
    <button class="delete" onclick="hideElm('flyImageResponseContainer');"></button>
    <div id="flyImageResponse"></div>
</div>

<div class="flex-card card_border">

    <div class="flex-content-wrap" style="margin: 5px 5px;width:100%;min-height:0px;" onclick="toggleElm('manageFlyImages');toggleElm('flyImageOpen'); toggleElm('flyImageClose');">
        <div class="flex-item-stretch" style="text-align:center;">
            <strong>Refresh/Update/Push Docker Images</strong>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" id="flyImageOpen" style="width:16px;height:16px;margin:0 10px 0 0;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 13l-7 7-7-7m14-8l-7 7-7-7" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="flyImageClose" style="width:16px;height:16px;margin:0 10px 0 0;display:none;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 11l7-7 7 7M5 19l7-7 7 7" />
        </svg>
    </div>

    <div id="manageFlyImages" style="display:none;">

        <div class="flex-content-wrap" style="width:100%;text-align: center;margin: 10px 0px;">
            <button class="button border" id="pushImage" style="margin: 0 5px 5px 0; min-width: 75px; height: 40px; background-color: lightgray; color: black; font-weight: bolder;"
                    onclick="flyRefreshMachineImage('flyRefreshMachineImageProgress', 'flyImageResponse', getElm('flyAuthToken').value, getElm('flyOrgSlug').value, getElm('flyAppSelect').value, function () { })">
                Refresh Machine Image <div id="flyRefreshMachineImageProgress"></div>
            </button>
        </div>

        <div class="flex-content-wrap" style="width:100%;text-align: center;margin: 10px 0px;">
            <button class="button border" id="pushImage" style="margin: 0 5px 5px 0; min-width: 75px; height: 40px; background-color: lightgray; color: black; font-weight: bolder;"
                    onclick="flyUpdateImage('flyUpdateImageProgress', 'flyImageResponse', getElm('flyAuthToken').value, getElm('flyOrgSlug').value, getElm('flyAppSelect').value, function () { })">
                Update Image <div id="flyUpdateImageProgress"></div>
            </button>
        </div>

        <div class="flex-content-wrap" style="margin: 5px 0px;">
            <label style="color:blue;font-size:x-small">Update Image will save the exiting edgeapp including any changes as latest docker image which will get reflected on machine update</label>
        </div>

        <div class="flex-content-wrap">
            <label style="width:100%;margin: 5px auto;">Docker Image*</label>
            <div class="flex-item-stretch border" style="height: 40px;">
                <div class="flex-item-stretch border" style="height: 40px;">
                    <input style="width:100%;border:none;" id="dockerImage" type="text" placeholder="Docker Image Full Name" value="" />
                </div>
            </div>
        </div>

        <div class="flex-content-wrap" style="width:100%;text-align: center;margin: 10px 0px;">
            <button class="button border" id="pushImage" style="margin: 0 5px 5px 0; min-width: 75px; height: 40px; background-color: lightgray; color: black; font-weight: bolder;"
                    onclick="flyPushImage('flyPushImageProgress', 'flyImageResponse', getElm('flyAuthToken').value, getElm('flyAppSelect').value, getElm('dockerImage').value, function () { })">
                Push Image <div id="flyPushImageProgress"></div>
            </button>
        </div>

        <div class="flex-content-wrap" style="margin: 5px 0px;">
            <label style="color:red;font-size:x-small">Warning: Pushing new Docker Image will overwrite exiting edgeapp docker image which will get reflected on machine update</label>
        </div>

    </div>

</div>


